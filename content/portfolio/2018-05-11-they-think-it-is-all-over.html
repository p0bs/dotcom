---
title: "Is it all over?"
author: "Robin Penfold"
date: "2018-05-11"
showonlyimage: false
draft: false
slug: "they-think-it-is-all-over"
image: "img/portfolio/PPlogo.jpg"
description: "Projecting the competition winner one week out"
weight: 2
output:
  blogdown::html_page:
    highlight: pygments
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/pymjs/pym.v1.js"></script>
<script src="/rmarkdown-libs/widgetframe-binding/widgetframe.js"></script>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<p></br></p>
<p>… but it isn’t. In a curious turn of fate, each possible winner has about the same chance as the team that they love or endure:</p>
<ul>
<li><p><em>George Quin</em> – 60%, like Arsenal winning away at Huddersfield</p></li>
<li><p><em>Jon Poole</em> – 38%, like Everton winning away at West Ham</p></li>
<li><p><em>Beth Penfold</em> – 4%, like the chance of having to endure watching Chelsea in the Champions League next season; and</p></li>
<li><p><em>Mike Finnis</em> has about the same chance as Cambridge United winning next year’s FA Cup (i.e. think of a very small number).</p></li>
</ul>
<p>Oh, and others may have a tiny chance of winning, but my calculations don’t show it. FWIW, here are the gory details.</p>
<p></br></p>
<div id="current-standings" class="section level2">
<h2>Current standings</h2>
<p>Let’s start with the current standings:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressMessages</span>(<span class="kw">library</span>(tidyverse))
<span class="kw">library</span>(DT)
<span class="kw">library</span>(magrittr)
<span class="kw">library</span>(lazyeval)
<span class="kw">library</span>(widgetframe)
    
clubOrder &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;data/clubOrder-180511.rds&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_data_frame</span>(.)

clubOrder<span class="op">$</span>Team &lt;-<span class="st"> </span><span class="kw">recode</span>(clubOrder<span class="op">$</span>Team,
  <span class="st">`</span><span class="dt">AFC Bournemouth</span><span class="st">`</span> =<span class="st"> &quot;Bournemouth&quot;</span>,
  <span class="st">`</span><span class="dt">C Palace</span><span class="st">`</span> =<span class="st"> &quot;Crystal Palace&quot;</span>,
  <span class="dt">Spurs =</span> <span class="st">&quot;Tottenham&quot;</span>)
  
clubsABC &lt;-<span class="st"> </span><span class="kw">sort</span>(clubOrder<span class="op">$</span>Team)
  
dataInput &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/PP-2018.csv&quot;</span>)
clubStandings &lt;-<span class="st"> </span><span class="kw">match</span>(dataInput<span class="op">$</span>Club, clubOrder<span class="op">$</span>Team, <span class="dv">0</span>)
topClub &lt;-<span class="st"> </span><span class="kw">match</span>(<span class="dv">1</span>, clubStandings, <span class="dv">0</span>)
  
predictions &lt;-<span class="st"> </span>dataInput[,<span class="op">-</span><span class="dv">1</span>]
  
bonus &lt;-<span class="st"> </span><span class="dv">-50</span><span class="op">*</span>(predictions[topClub,]<span class="op">==</span><span class="dv">1</span>)
ssq &lt;-<span class="st"> </span><span class="cf">function</span>(x){(x<span class="op">-</span>clubStandings)<span class="op">^</span><span class="dv">2</span>}
squares &lt;-<span class="st"> </span><span class="kw">apply</span>(predictions,<span class="dv">2</span>,ssq)
score &lt;-<span class="st"> </span><span class="kw">colSums</span>(squares) <span class="op">+</span><span class="st"> </span>bonus
names &lt;-<span class="st"> </span><span class="kw">colnames</span>(score)
names1 &lt;-<span class="st"> </span><span class="kw">str_replace_all</span>(names, <span class="st">&quot;_&quot;</span>, <span class="st">&quot; &quot;</span>)
worst &lt;-<span class="st"> </span><span class="kw">apply</span>(squares,<span class="dv">2</span>,max)
findWorst &lt;-<span class="st"> </span><span class="cf">function</span>(y){<span class="kw">match</span>(worst[y],squares[,y],<span class="dv">0</span>)}
worstClubNo &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(predictions),findWorst)
worstClub &lt;-<span class="st"> </span>clubsABC[worstClubNo]
  
output &lt;-<span class="st"> </span><span class="kw">rbind</span>(score, bonus, worst, worstClubNo)
output1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(names1,<span class="kw">t</span>(output))
<span class="kw">row.names</span>(output1) &lt;-<span class="st"> </span><span class="ot">NULL</span> 
output2 &lt;-<span class="st"> </span>output1 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">worstClub=</span>clubsABC[worstClubNo]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>worstClubNo) 
<span class="kw">colnames</span>(output2) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Names&quot;</span>, <span class="st">&quot;Scores&quot;</span>, <span class="st">&quot;Bonus&quot;</span>, <span class="st">&quot;WorstCost&quot;</span>, <span class="st">&quot;WorstClub&quot;</span>)
  
report &lt;-<span class="st"> </span>output2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(Scores) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Names, Scores, Bonus, WorstClub, WorstCost)
  
dtReport &lt;-<span class="st"> </span><span class="kw">datatable</span>(report, 
          <span class="dt">rownames =</span> <span class="ot">FALSE</span>, 
          <span class="dt">options =</span> <span class="kw">list</span>(<span class="dt">dom =</span> <span class="st">&#39;t&#39;</span>,
                         <span class="dt">pageLength =</span> <span class="dv">23</span>,
                         <span class="dt">order =</span> <span class="kw">list</span>(
                           <span class="kw">list</span>(<span class="dv">1</span>, <span class="st">&#39;asc&#39;</span>), 
                           <span class="kw">list</span>(<span class="dv">0</span>, <span class="st">&#39;asc&#39;</span>)
                           )
                         )
          )
  
<span class="kw">frameWidget</span>(dtReport, <span class="dt">width =</span> <span class="st">&#39;100%&#39;</span>, <span class="dt">height =</span> <span class="dv">800</span>)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:800px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"url":"/portfolio/2018-05-11-they-think-it-is-all-over_files/figure-html//widgets/widget_thecode18p1.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p></br></p>
</div>
<div id="predictions-and-positions" class="section level2">
<h2>Predictions and Positions</h2>
<p>Next, we’ll consider your team-by-team predictions and each team’s latest Position in the league. (Note that you can hover over the table and scroll to the right if you want.)</p>
<pre class="sourceCode r"><code class="sourceCode r">Position &lt;-<span class="st"> </span><span class="kw">as.vector</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>)
clubsOrder &lt;-<span class="st"> </span>clubOrder<span class="op">$</span>Team
clubsOrder1 &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">cbind</span>(clubsOrder, Position)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">Club =</span> clubsOrder) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(dataInput, <span class="dt">by =</span> <span class="st">&quot;Club&quot;</span>)
  
dtClubsOrder1 &lt;-<span class="st"> </span><span class="kw">datatable</span>(clubsOrder1,
          <span class="dt">rownames =</span> <span class="ot">FALSE</span>,
          <span class="dt">options =</span> <span class="kw">list</span>(
            <span class="dt">dom =</span> <span class="st">&#39;t&#39;</span>,
            <span class="dt">pageLength =</span> <span class="dv">20</span>,
            <span class="dt">scrollX =</span> <span class="ot">TRUE</span>,
            <span class="dt">order =</span> <span class="kw">list</span>(<span class="dv">1</span>, <span class="st">&#39;asc&#39;</span>),
            <span class="dt">columnDefs =</span> <span class="kw">list</span>(
              <span class="kw">list</span>(
                <span class="dt">className =</span> <span class="st">&#39;dt-right&#39;</span>, 
                <span class="dt">targets =</span> <span class="dv">1</span>)
              )
            )
          )
  
<span class="kw">frameWidget</span>(dtClubsOrder1, <span class="dt">width =</span> <span class="st">&#39;100%&#39;</span>, <span class="dt">height =</span> <span class="dv">800</span>)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:800px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"url":"/portfolio/2018-05-11-they-think-it-is-all-over_files/figure-html//widgets/widget_thecode18p2.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p></br></p>
</div>
<div id="projections" class="section level2">
<h2>Projections</h2>
<p>Finally, we’ll project your likely success. (And the success is stable even if we use ten times the number of scenarios.)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Change code as shown below if champion has yet to be decided</span>
iterations &lt;-<span class="st"> </span><span class="dv">10000</span>
<span class="kw">set.seed</span>(<span class="dv">6</span>)
  
clubOrder <span class="op">%&lt;&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fullPts =</span> (<span class="dv">1000</span><span class="op">*</span>Pts) <span class="op">+</span><span class="st"> </span>GD)

clubsABC &lt;-<span class="st"> </span>clubOrder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Team, fullPts) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(Team)

clubStandings &lt;-<span class="st"> </span><span class="kw">match</span>(dataInput<span class="op">$</span>Club, clubOrder<span class="op">$</span>Team, <span class="dv">0</span>)

predictions &lt;-<span class="st"> </span>dataInput[,<span class="op">-</span><span class="dv">1</span>]
nPlayers &lt;-<span class="st"> </span><span class="kw">ncol</span>(predictions)

ssq &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="kw">sum</span>((x<span class="op">-</span>clubStandings)<span class="op">^</span><span class="dv">2</span>)}
score &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">apply</span>(predictions,<span class="dv">2</span>,ssq))
names &lt;-<span class="st"> </span><span class="kw">as_data_frame</span>(<span class="kw">rownames</span>(score))
names1 &lt;-<span class="st"> </span><span class="kw">as_data_frame</span>(<span class="kw">str_replace_all</span>(<span class="kw">t</span>(names), <span class="st">&quot;_&quot;</span>, <span class="st">&quot; &quot;</span>))
  
bookiesInput &lt;-<span class="st"> </span><span class="kw">data_frame</span>(
  <span class="dt">game =</span> <span class="kw">c</span>(<span class="st">&quot;Burnley-Bournemouth&quot;</span>, <span class="st">&quot;Crystal Palace-West Brom&quot;</span>, <span class="st">&quot;Huddersfield-Arsenal&quot;</span>, <span class="st">&quot;Liverpool-Brighton&quot;</span>, <span class="st">&quot;Man Utd-Watford&quot;</span>, <span class="st">&quot;Newcastle-Chelsea&quot;</span>, <span class="st">&quot;Southampton-Man City&quot;</span>, <span class="st">&quot;Swansea-Stoke&quot;</span>, <span class="st">&quot;Tottenham-Leicester&quot;</span>, <span class="st">&quot;West Ham-Everton&quot;</span>),
  <span class="dt">homeValue =</span> <span class="kw">c</span>(<span class="fl">2.15</span>, <span class="fl">1.75</span>, <span class="fl">5.5</span>, <span class="fl">1.18</span>, <span class="fl">1.36</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="fl">1.87</span>, <span class="fl">1.3</span>, <span class="fl">2.35</span>),
  <span class="dt">drawValue =</span> <span class="kw">c</span>(<span class="fl">3.4</span>, <span class="fl">3.75</span>, <span class="fl">4.25</span>, <span class="dv">7</span>, <span class="dv">5</span>, <span class="dv">4</span>, <span class="fl">4.6</span>, <span class="fl">3.7</span>, <span class="fl">5.5</span>, <span class="fl">3.4</span>), 
  <span class="dt">awayValue =</span> <span class="kw">c</span>(<span class="fl">3.4</span>, <span class="fl">4.6</span>, <span class="fl">1.57</span>, <span class="dv">13</span>, <span class="dv">9</span>, <span class="fl">1.57</span>, <span class="fl">1.44</span>, <span class="fl">3.9</span>, <span class="fl">9.5</span>, <span class="dv">3</span>))
  
oddsData &lt;-<span class="st"> </span>bookiesInput <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">separate</span>(<span class="dt">col =</span> game, 
           <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;homeTeam&quot;</span>, <span class="st">&quot;awayTeam&quot;</span>), 
           <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>, 
           <span class="dt">remove =</span> <span class="ot">FALSE</span>)
  
gameOddsBuilder &lt;-<span class="st"> </span>oddsData <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">overround =</span> (<span class="dv">1</span><span class="op">/</span>homeValue) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">/</span>drawValue) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">/</span>awayValue),
         <span class="dt">homeLikelihood =</span> <span class="dv">1</span><span class="op">/</span>(homeValue <span class="op">*</span><span class="st"> </span>overround),
         <span class="dt">drawLikelihood =</span> <span class="dv">1</span><span class="op">/</span>(drawValue <span class="op">*</span><span class="st"> </span>overround),
         <span class="dt">awayLikelihood =</span> <span class="dv">1</span><span class="op">/</span>(awayValue <span class="op">*</span><span class="st"> </span>overround),
         <span class="dt">winSlice =</span> homeLikelihood,
         <span class="dt">drawSlice =</span> homeLikelihood <span class="op">+</span><span class="st"> </span>drawLikelihood)
    
vectorRandom &lt;-<span class="st"> </span><span class="kw">as_vector</span>(
  <span class="kw">ceiling</span>(
    <span class="kw">runif</span>(
      <span class="dv">10</span><span class="op">*</span>iterations, 
      <span class="dt">min =</span> <span class="dv">0</span>, 
      <span class="dt">max =</span> <span class="dv">7</span>)
    )
  )
    
netGameGoals &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">data =</span> vectorRandom, <span class="dt">ncol =</span> <span class="dv">10</span>)
<span class="kw">colnames</span>(netGameGoals) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;n&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)
  
unitVectorRandom &lt;-<span class="st"> </span><span class="kw">as.vector</span>(<span class="kw">runif</span>(<span class="dv">10</span><span class="op">*</span>iterations, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">1</span>))
randomGameValues &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">data =</span> unitVectorRandom, <span class="dt">ncol =</span> <span class="dv">10</span>)
<span class="kw">colnames</span>(randomGameValues) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;r&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)

simulatedCalcs &lt;-<span class="st"> </span><span class="kw">data_frame</span>(
  <span class="dt">iteration =</span> <span class="kw">seq.int</span>(iterations)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">cbind</span>(randomGameValues, netGameGoals)
  
pointsAdjuster &lt;-<span class="st"> </span><span class="cf">function</span>(team) {
  
  teamName &lt;-<span class="st"> </span><span class="kw">enquo</span>(team)
  
  matchNo &lt;-<span class="st"> </span>teamData<span class="op">$</span>matchNo[teamData<span class="op">$</span>team <span class="op">==</span><span class="st"> </span><span class="kw">uq</span>(teamName)]
  isHomeTeam &lt;-<span class="st"> </span>teamData<span class="op">$</span>isHomeTeam[teamData<span class="op">$</span>team <span class="op">==</span><span class="st"> </span><span class="kw">uq</span>(teamName)]
  existingPoints &lt;-<span class="st"> </span>clubsABC<span class="op">$</span>fullPts[clubsABC <span class="op">==</span><span class="st"> </span><span class="kw">uq</span>(teamName)]
  winBreakpoint &lt;-<span class="st"> </span>teamData<span class="op">$</span>winSlice[teamData<span class="op">$</span>team <span class="op">==</span><span class="st"> </span><span class="kw">uq</span>(teamName)]
  drawBreakpoint &lt;-<span class="st"> </span>teamData<span class="op">$</span>drawSlice[teamData<span class="op">$</span>team <span class="op">==</span><span class="st"> </span><span class="kw">uq</span>(teamName)]
  workings &lt;-<span class="st"> </span><span class="kw">tibble</span>(
    <span class="dt">firstColumn =</span> simulatedCalcs[, (matchNo <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)],
    <span class="dt">secondColumn =</span> simulatedCalcs[, (matchNo <span class="op">+</span><span class="st"> </span><span class="dv">11</span>)])
  
  existingPoints <span class="op">+</span><span class="st"> </span><span class="cf">if</span> (isHomeTeam <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>) {
    workings <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">mutate</span>(
        <span class="dt">newPoints =</span> <span class="kw">ifelse</span>(
          firstColumn <span class="op">&lt;</span><span class="st"> </span>winBreakpoint,
          <span class="dv">3000</span> <span class="op">+</span><span class="st"> </span>secondColumn,
          <span class="kw">ifelse</span>(
            firstColumn <span class="op">&lt;</span><span class="st"> </span>drawBreakpoint,
            <span class="dv">1000</span>, 
            <span class="op">-</span>secondColumn)
          )
        ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">pull</span>(newPoints)
    
  } <span class="cf">else</span> {
    
    workings <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">mutate</span>(
        <span class="dt">newPoints =</span> <span class="kw">ifelse</span>(
          firstColumn <span class="op">&lt;</span><span class="st"> </span>winBreakpoint,
          <span class="op">-</span>secondColumn,
          <span class="kw">ifelse</span>(
            firstColumn <span class="op">&lt;</span><span class="st"> </span>drawBreakpoint, 
            <span class="dv">1000</span>, 
            <span class="dv">3000</span> <span class="op">+</span><span class="st"> </span>secondColumn)
          )
        ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">pull</span>(newPoints)
    }
}
  
homeTeamData &lt;-<span class="st"> </span>gameOddsBuilder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rownames_to_column</span>(<span class="dt">var =</span> <span class="st">&quot;matchNo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(
    <span class="dt">team =</span> homeTeam,
    <span class="dt">otherTeam =</span> awayTeam) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(team, otherTeam, game, matchNo, homeValue<span class="op">:</span>drawSlice) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">isHomeTeam =</span> <span class="ot">TRUE</span>,
    <span class="dt">matchNo =</span> <span class="kw">as.integer</span>(matchNo))
  
awayTeamData &lt;-<span class="st"> </span>gameOddsBuilder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">rownames_to_column</span>(<span class="dt">var =</span> <span class="st">&quot;matchNo&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(
    <span class="dt">team =</span> awayTeam,
    <span class="dt">otherTeam =</span> homeTeam) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(team, otherTeam, game, matchNo, homeValue<span class="op">:</span>drawSlice) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">isHomeTeam =</span> <span class="ot">FALSE</span>,
    <span class="dt">matchNo =</span> <span class="kw">as.integer</span>(matchNo))
  
teamData &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(homeTeamData, awayTeamData) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(matchNo, <span class="kw">desc</span>(isHomeTeam))
  
adjustedPoints &lt;-<span class="st"> </span>clubsABC<span class="op">$</span>Team <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">map</span>(pointsAdjuster) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as.data.frame</span>()
  
<span class="kw">colnames</span>(adjustedPoints) &lt;-<span class="st"> </span>clubsABC<span class="op">$</span>Team
  
simClubOrderString &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">apply</span>(<span class="op">-</span>adjustedPoints, <span class="dv">1</span>, rank, <span class="dt">ties.method=</span><span class="st">&quot;average&quot;</span>))
tsimClubOrder &lt;-<span class="st"> </span><span class="kw">matrix</span>(simClubOrderString, <span class="dt">nrow =</span> <span class="dv">20</span>)
  
simClubOrder &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">t</span>(tsimClubOrder))
<span class="kw">colnames</span>(simClubOrder) &lt;-<span class="st"> </span>clubsABC<span class="op">$</span>Team
  
simPlayerScores &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(0L, nPlayers<span class="op">*</span>iterations), <span class="dt">nrow =</span> iterations)
tPredictions &lt;-<span class="st"> </span><span class="kw">t</span>(predictions)
  
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nPlayers){
  
  mPredictions &lt;-<span class="st"> </span><span class="kw">matrix</span>(
    <span class="kw">rep</span>(tPredictions[i,], iterations), 
    <span class="dt">nrow =</span> iterations, 
    <span class="dt">byrow =</span> <span class="ot">TRUE</span>)
  
  workingMisses &lt;-<span class="st"> </span>(simClubOrder <span class="op">-</span><span class="st"> </span>mPredictions)<span class="op">^</span><span class="dv">2</span>
  bonusScore &lt;-<span class="st"> </span><span class="dv">-50</span> <span class="op">*</span><span class="st"> </span>(tPredictions[i,<span class="dv">4</span>] <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)   <span class="co"># Change if champion isn&#39;t certain</span>
  
  simPlayerScores[,i] &lt;-<span class="st"> </span><span class="kw">rowSums</span>(workingMisses) <span class="op">+</span><span class="st"> </span>bonusScore
}
  
<span class="kw">colnames</span>(simPlayerScores) &lt;-<span class="st"> </span><span class="kw">t</span>(names1)
  
simPlayerRanks &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="kw">t</span>(
    <span class="kw">apply</span>(simPlayerScores, <span class="dv">1</span>, rank, <span class="dt">ties.method=</span><span class="st">&#39;min&#39;</span>)
    )
  )
  
winPlayer &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(simPlayerRanks<span class="op">==</span>1L)

winLikelihood &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(
  <span class="kw">apply</span>(winPlayer, <span class="dv">2</span>, sum)
  )
  
<span class="kw">colnames</span>(winLikelihood)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;Frequency&quot;</span>
<span class="kw">colnames</span>(names1)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;Name&quot;</span>
  
winSummary &lt;-<span class="st"> </span><span class="kw">cbind</span>(names1, winLikelihood) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(Frequency <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="op">-</span>Frequency) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Likelihood =</span> Frequency<span class="op">/</span>iterations) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Name, Likelihood) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_tibble</span>(.)
  
dtWinSummary &lt;-<span class="st"> </span><span class="kw">datatable</span>(winSummary,
          <span class="dt">rownames =</span> <span class="ot">FALSE</span>,
          <span class="dt">options =</span> <span class="kw">list</span>(<span class="dt">dom =</span> <span class="st">&#39;t&#39;</span>,
                         <span class="dt">pageLength =</span> <span class="dv">20</span>,
                         <span class="dt">order =</span> <span class="kw">list</span>(<span class="dv">1</span>, <span class="st">&#39;desc&#39;</span>),
                         <span class="dt">columnDefs =</span> <span class="kw">list</span>(<span class="kw">list</span>(
            <span class="dt">className =</span> <span class="st">&#39;dt-left&#39;</span>, <span class="dt">targets =</span> <span class="dv">0</span>),<span class="kw">list</span>(
            <span class="dt">className =</span> <span class="st">&#39;dt-right&#39;</span>, <span class="dt">targets =</span> <span class="dv">1</span>)))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">formatPercentage</span>(<span class="st">&#39;Likelihood&#39;</span>, <span class="dv">1</span>)
  
<span class="kw">frameWidget</span>(dtWinSummary, <span class="dt">width =</span> <span class="st">&#39;100%&#39;</span>, <span class="dt">height =</span> <span class="dv">250</span>)</code></pre>
<div id="htmlwidget-3" style="width:100%;height:250px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"url":"/portfolio/2018-05-11-they-think-it-is-all-over_files/figure-html//widgets/widget_thecode18p3.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>By the way, these calculations also suggest that Chelsea have only a 4.2% chance of being in the Champions League next season. <grimace></p>
<p>For more detail, check out the up-to-the-minute <a href="https://robin.shinyapps.io/PremPredict/">PremPredict Leaderboard</a>.</p>
<p></br></p>
</div>
