---
title: "Package-tastic"
author: "Robin Penfold"
date: "2018-10-19"
showonlyimage: false
draft: false
slug: "R-package-for-that"
image: "img/portfolio/hex.jpeg"
description: "Understanding Brexit with R's versatility"
weight: 2
output:
  blogdown::html_page:
    highlight: pygments
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/pymjs/pym.v1.js"></script>
<script src="/rmarkdown-libs/widgetframe-binding/widgetframe.js"></script>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<p>Here’s a page that I prepared for an R training course that I ran at my company. The idea was to show that, just like Apple, R has an app for that. OK, a package for that.</p>
<p>I’ll show a range of tricks made possible by R, including web scaping, text analysis and mapping. And I’ll use data from the recent Brexit referendum to keep it topical.</p>
<p>
 
</p>
<div id="loading-the-packages" class="section level3">
<h3>Loading the packages</h3>
<p>Let’s begin with the packages:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)        <span class="co"># Does most of what you need</span>
<span class="kw">library</span>(xml2)             <span class="co"># Scrapes web data</span>
<span class="kw">library</span>(htmlwidgets)      <span class="co"># For responsive exhibits</span>
<span class="kw">library</span>(widgetframe)      <span class="co"># For responsive exhibits</span>
<span class="kw">library</span>(DT)               <span class="co"># For responsive data tables</span>
<span class="kw">library</span>(leaflet)          <span class="co"># For interactive map plots</span>
<span class="kw">library</span>(maptools)         <span class="co"># For maps</span>
<span class="kw">library</span>(sp)               <span class="co"># For map-like data</span></code></pre>
<p>
 
</p>
</div>
<div id="web-scraping" class="section level3">
<h3>Web scraping</h3>
<p>To understand the voting in the Brexit referendum, we need some data about it, which we can scrape from the FT’s page on the subject.</p>
<p>(Note that I’ve dimmed-out much of this code below, so that I can show it on this static webpage. However, I ran the dimmed-out code separately and saved the ensuing results as an R Dataset. I can then just load this dataset for use on this static webpage.)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># webResults &lt;- read_html(&quot;https://ig.ft.com/sites/elections/2016/uk/eu-referendum/&quot;)</span>
  
<span class="co"># webData &lt;- webResults %&gt;%</span>
<span class="co">#   html_nodes(&quot;td:nth-child(1) , .area-state-3 .hideable&quot;) %&gt;%</span>
<span class="co">#   html_text()</span>
  
<span class="co"># saveRDS(webData, &quot;webData.rds&quot;)</span>
  
webData &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;data/webData.rds&quot;</span>)
<span class="kw">head</span>(webData)</code></pre>
<pre><code>## [1] &quot;Boston&quot;        &quot;7,430&quot;         &quot;22,974&quot;        &quot;South Holland&quot;
## [5] &quot;13,074&quot;        &quot;36,423&quot;</code></pre>
<p>
 
</p>
</div>
<div id="dealing-with-strings" class="section level3">
<h3>Dealing with strings</h3>
<p>That gives us some data, but it is an unhelpful format, as R would read it with a character that has a comma in the middle. Fortunately, R can manipulate strings so that they make sense, such as removing those commas:</p>
<pre class="sourceCode r"><code class="sourceCode r">lWebData &lt;-<span class="st"> </span><span class="kw">length</span>(webData)
  
areaName &lt;-<span class="st"> </span>webData[<span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">1</span>, <span class="dt">to =</span> lWebData<span class="dv">-2</span>, <span class="dt">by =</span> <span class="dv">3</span>)]
remainVotes &lt;-<span class="st"> </span>webData[<span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">2</span>, <span class="dt">to =</span> lWebData<span class="dv">-1</span>, <span class="dt">by =</span> <span class="dv">3</span>)]
leaveVotes &lt;-<span class="st"> </span>webData[<span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">3</span>, <span class="dt">to =</span> lWebData, <span class="dt">by =</span> <span class="dv">3</span>)]
  
remainVotes &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;,([0-9])&quot;</span>, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>, remainVotes)
leaveVotes &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;,([0-9])&quot;</span>, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>, leaveVotes)
  
resultsData &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">t</span>(<span class="kw">rbind</span>(areaName, remainVotes, leaveVotes)), <span class="dt">stringsAsFactors =</span> F)
  
resultsData<span class="op">$</span>remainVotes &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(resultsData<span class="op">$</span>remainVotes)
  
resultsData<span class="op">$</span>leaveVotes &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(resultsData<span class="op">$</span>leaveVotes)</code></pre>
<p>
 
</p>
</div>
<div id="map-and-boundary-data" class="section level3">
<h3>Map and boundary data</h3>
<p>To understand this data even more, it would help to map it. And the amount of boundary files available for UK maps is extraordinary. R helps us to use these maps, so that we can map each local authority (the areas over which the referendum votes were amalgamated). (As before, I’ve run the dimmed-out code beforehand and saved the RDS, for use on this page.)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># localAuthorityRaw &lt;- readShapeSpatial(&quot;Local_Authority_District_(GB)_2015_boundaries_(generalised_clipped)/LAD_DEC_2015_GB_BGC.shp&quot;, proj4string=CRS(&quot;+init=epsg:27700&quot;))</span>
  
<span class="co"># # Transform the data to use with ggmap</span>
<span class="co"># localAuthorityClean &lt;- spTransform(localAuthorityRaw, CRS(&quot;+init=epsg:4326&quot;))</span>
  
<span class="co"># # Turns the data into a dataframe</span>
<span class="co"># localAuthorityCleanDF &lt;- fortify(localAuthorityClean, region = &quot;LAD15NM&quot;)</span>
  
<span class="co"># saveRDS(localAuthorityCleanDF, &quot;localAuthorityCleanDF.rds&quot;)</span>
  
localAuthorityCleanDF &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;data/localAuthorityCleanDF.rds&quot;</span>)</code></pre>
<p>
 
</p>
</div>
<div id="understand-any-mislabelling" class="section level3">
<h3>Understand any mislabelling</h3>
<p>Being real-world data, though, the Local Authorities that we scraped from the web do not all match those for which we have boundary files. Fortuntately, R can help us to understand the erroneous labels in the data.</p>
<pre class="sourceCode r"><code class="sourceCode r">l1 &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">unique</span>(localAuthorityCleanDF<span class="op">$</span>id), <span class="dt">stringsAsFactors =</span> F)
<span class="kw">colnames</span>(l1)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;locAuthID&quot;</span>
areaNameDF &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(areaName, <span class="dt">stringsAsFactors =</span> F)
  
l2 &lt;-<span class="st"> </span>l1 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">check =</span> locAuthID <span class="op">%in%</span><span class="st"> </span>areaNameDF<span class="op">$</span>areaName)
  
l3 &lt;-<span class="st"> </span>areaNameDF <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">check =</span> areaName <span class="op">%in%</span><span class="st"> </span>l1<span class="op">$</span>locAuthID)
  
<span class="kw">print</span>(l2[l2<span class="op">$</span>check<span class="op">==</span>F,])</code></pre>
<pre><code>##                       locAuthID check
## 1                 Aberdeen City FALSE
## 40             Bristol, City of FALSE
## 71            City of Edinburgh FALSE
## 80                County Durham FALSE
## 96                  Dundee City FALSE
## 130                Glasgow City FALSE
## 152    Herefordshire, County of FALSE
## 171 Kingston upon Hull, City of FALSE
## 172        Kingston upon Thames FALSE
## 208         Newcastle upon Tyne FALSE
## 253        Richmond upon Thames FALSE
## 303                  St. Helens FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(l3[l3<span class="op">$</span>check<span class="op">==</span>F,])</code></pre>
<pre><code>##                 areaName check
## 24                  Hull FALSE
## 109        Herefordshire FALSE
## 134            St Helens FALSE
## 139               Durham FALSE
## 270  Newcastle-upon-Tyne FALSE
## 308     Northern Ireland FALSE
## 339               Dundee FALSE
## 345             Aberdeen FALSE
## 347 Kingston-upon-Thames FALSE
## 348              Bristol FALSE
## 360              Glasgow FALSE
## 366 Richmond-upon-Thames FALSE
## 374            Edinburgh FALSE
## 382            Gibraltar FALSE</code></pre>
<p>Given these erroneous labels, we can then correct these errors (and drop two areas from our analysis).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Given these mislabelled regions, alter the names</span>
resultsData<span class="op">$</span>areaName &lt;-<span class="st"> </span><span class="kw">recode</span>(
  resultsData<span class="op">$</span>areaName,
  <span class="dt">Hull =</span> <span class="st">&quot;Kingston upon Hull, City of&quot;</span>,
  <span class="dt">Herefordshire =</span> <span class="st">&quot;Herefordshire, County of&quot;</span>,
  <span class="st">`</span><span class="dt">St Helens</span><span class="st">`</span> =<span class="st"> &quot;St. Helens&quot;</span>,
  <span class="dt">Durham =</span> <span class="st">&quot;County Durham&quot;</span>,
  <span class="st">`</span><span class="dt">Newcastle-upon-Tyne</span><span class="st">`</span> =<span class="st"> &quot;Newcastle upon Tyne&quot;</span>,
  <span class="dt">Dundee =</span> <span class="st">&quot;Dundee City&quot;</span>,
  <span class="dt">Aberdeen =</span> <span class="st">&quot;Aberdeen City&quot;</span>,
  <span class="st">`</span><span class="dt">Kingston-upon-Thames</span><span class="st">`</span> =<span class="st"> &quot;Kingston upon Thames&quot;</span>,
  <span class="dt">Bristol =</span> <span class="st">&quot;Bristol, City of&quot;</span>,
  <span class="dt">Glasgow =</span> <span class="st">&quot;Glasgow City&quot;</span>,
  <span class="st">`</span><span class="dt">Richmond-upon-Thames</span><span class="st">`</span> =<span class="st"> &quot;Richmond upon Thames&quot;</span>,
  <span class="dt">Edinburgh =</span> <span class="st">&quot;City of Edinburgh&quot;</span>)

<span class="co"># Drop NI and Gibraltar</span>
mapDataSummary &lt;-<span class="st"> </span>resultsData[<span class="kw">c</span>(<span class="op">-</span><span class="dv">308</span>, <span class="dv">-382</span>)]</code></pre>
<p>
 
</p>
</div>
<div id="calculate-the-centrepoint-of-the-local-authority" class="section level3">
<h3>Calculate the centrepoint of the local authority</h3>
<p>We could use the polygon details that we have to map our data. However, circles on a map would enable us to alter the size of the circle and therefore show the data in more detail. As such, we’ll use R to calculate the centrepoints of each Local Authority.</p>
<pre class="sourceCode r"><code class="sourceCode r">mapDataLng &lt;-<span class="st"> </span>localAuthorityCleanDF <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">avLng =</span> <span class="kw">round</span>(<span class="kw">median</span>(long),<span class="dv">4</span>))
  
mapDataLat &lt;-<span class="st"> </span>localAuthorityCleanDF <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">avLat =</span> <span class="kw">round</span>(<span class="kw">median</span>(lat),<span class="dv">4</span>))
  
mapDataLngLat &lt;-<span class="st"> </span>mapDataLat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(mapDataLng, <span class="dt">by =</span> <span class="st">&quot;id&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">areaName =</span> id)</code></pre>
<p>
 
</p>
</div>
<div id="join-and-amend-the-data" class="section level3">
<h3>Join and amend the data</h3>
<p>We can then join the map data to the voting data and determine the proportion of leave votes, along with the total number of votes cast in each Local Authority. The following interactive table provides the details.</p>
<pre class="sourceCode r"><code class="sourceCode r">mapDataFinal &lt;-<span class="st"> </span>mapDataSummary <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(mapDataLngLat, <span class="dt">by =</span> <span class="st">&quot;areaName&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">leaveShare =</span> <span class="kw">round</span>(leaveVotes<span class="op">/</span>(leaveVotes <span class="op">+</span><span class="st"> </span>remainVotes),<span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">size =</span> leaveVotes <span class="op">+</span><span class="st"> </span>remainVotes)
  
mapDataFinal &lt;-<span class="st"> </span>mapDataFinal[<span class="kw">complete.cases</span>(mapDataFinal),]
  
dt &lt;-<span class="st"> </span><span class="kw">datatable</span>(
  mapDataFinal, 
  <span class="dt">rownames =</span> <span class="ot">FALSE</span>, 
  <span class="dt">options =</span> <span class="kw">list</span>(
    <span class="dt">dom =</span> <span class="st">&#39;tip&#39;</span>, 
    <span class="dt">autoWidth =</span> <span class="ot">TRUE</span>,
    <span class="dt">order =</span> <span class="kw">list</span>(<span class="dv">5</span>, <span class="st">&#39;desc&#39;</span>), 
    <span class="dt">columnDefs =</span> <span class="kw">list</span>(
      <span class="kw">list</span>(
        <span class="dt">className =</span> <span class="st">&#39;dt-left&#39;</span>, 
        <span class="dt">targets =</span> <span class="dv">0</span>)
      ), 
    <span class="dt">pageLength =</span> <span class="dv">10</span>, 
    <span class="dt">fillContainer =</span> T
    )
  )
  
<span class="kw">frameWidget</span>(dt, <span class="dt">width =</span> <span class="dv">750</span>, <span class="dt">height =</span> <span class="dv">500</span>)</code></pre>
<div id="htmlwidget-1" style="width:750px;height:500px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"url":"/portfolio/2016-10-19-R-package-for-that_files/figure-html//widgets/widget_unnamed-chunk-8.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>
 
</p>
</div>
<div id="plotting-the-votes" class="section level3">
<h3>Plotting the votes</h3>
<p>We’re now ready to plot the data. When we do so, some regional trends become immediately apparent.</p>
<pre class="sourceCode r"><code class="sourceCode r">pal &lt;-<span class="st"> </span><span class="kw">colorNumeric</span>(<span class="dt">palette =</span> <span class="st">&quot;YlOrRd&quot;</span>, <span class="dt">domain =</span> mapDataFinal<span class="op">$</span>leaveShare)
  
map &lt;-<span class="st"> </span><span class="kw">leaflet</span>(mapDataFinal) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">addProviderTiles</span>(<span class="st">&quot;CartoDB.Positron&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setView</span>(<span class="dt">lng =</span> <span class="dv">-3</span>, <span class="dt">lat =</span> <span class="fl">53.5</span>, <span class="dt">zoom =</span> <span class="dv">6</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">addCircles</span>(<span class="dt">lng =</span> <span class="op">~</span>mapDataFinal<span class="op">$</span>avLng, 
             <span class="dt">lat =</span> <span class="op">~</span>mapDataFinal<span class="op">$</span>avLat, 
             <span class="dt">color =</span> <span class="op">~</span><span class="kw">pal</span>(mapDataFinal<span class="op">$</span>leaveShare), 
             <span class="dt">radius =</span> <span class="op">~</span><span class="dv">20</span><span class="op">*</span><span class="kw">sqrt</span>(size), 
             <span class="dt">stroke =</span> <span class="ot">FALSE</span>, 
             <span class="dt">fillOpacity =</span> <span class="fl">0.9</span>,
             <span class="dt">popup =</span> <span class="kw">paste</span>(mapDataFinal<span class="op">$</span>areaName, <span class="st">&quot;had &quot;</span>, <span class="kw">round</span>(<span class="dv">100</span><span class="op">*</span>mapDataFinal<span class="op">$</span>leaveShare, <span class="dv">1</span>), <span class="st">&quot;% voting for Leave and &quot;</span>, mapDataFinal<span class="op">$</span>size, <span class="st">&quot;total voters&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">addLegend</span>(<span class="st">&quot;topright&quot;</span>, <span class="dt">pal =</span> pal,
            <span class="dt">values =</span> <span class="op">~</span>mapDataFinal<span class="op">$</span>leaveShare,
            <span class="dt">title =</span> <span class="st">&quot;% of Leave voters&quot;</span>,
            <span class="dt">labFormat =</span> <span class="kw">labelFormat</span>(),
            <span class="dt">opacity =</span> <span class="dv">1</span>)
  
<span class="kw">frameWidget</span>(map, <span class="dt">height =</span> <span class="dv">400</span>)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:400px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"url":"/portfolio/2016-10-19-R-package-for-that_files/figure-html//widgets/widget_unnamed-chunk-9.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>
 
</p>
</div>
<div id="theres-a-package-for-that" class="section level3">
<h3>There’s a package for that</h3>
<p>And that’s it! Hopefully, this page has given you a quick appreciation of the variety of techniques that you can fruitfully employ in R.</p>
<p>
 
</p>
<hr />
</div>
