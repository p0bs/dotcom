---
title: "Mother battles daughter"
author: "Robin Penfold"
date: "2017-09-08"
type: "post"
showonlyimage: false
draft: false
slug: "mother-battles-daughter"
image: "img/portfolio/PPlogo.jpg"
description: "Congratulations to the Finnis ladies!"
weight: 3
output:
  blogdown::html_page:
    highlight: pygments
---
Welcome to this year's PremPredict, where there's a massive Â£110 pot up for grabs. And things must be heating up in the Finnis house, as **Marion** is currently edging **Hannah** out of first place.

<p style="height: .5em;">&nbsp;</p>

### Latest standings

With apologies in advance to two of our former winners -- who now lanuish at the bottom of the pile -- here are the latest standings:

```{r thecode181, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
library(tidyverse)
library(htmlwidgets)
library(widgetframe)
library(DT)
library(ggridges)
  
# Start by running this dimmed code (as PP-thin.R):
# library(rvest)
# library(xml2)
# leagueTable <- read_html("http://www.theguardian.com/football/premierleague/table")
# clubOrder <- leagueTable %>%
#   html_nodes(".table--striped") %>%
#   .[[1]] %>%
#   html_table()
# saveRDS(clubOrder, "clubOrder-080917.rds") # + date
# Then move clubOrder.rds to data drive
  
clubOrder <- readRDS("data/clubOrder-080917.rds")  # Add date
  
# Make the league table consistent with our inputs
clubOrder$Team <- recode(
  clubOrder$Team,
  `AFC Bournemouth` = "Bournemouth",
  `C Palace` = "Crystal Palace",
  Spurs = "Tottenham")
  
clubsABC <- sort(clubOrder$Team)
  
dataInput <- read_csv("data/PP-2018.csv")
clubStandings <- match(dataInput$Club, clubOrder$Team, 0)
topClub <- match(1, clubStandings, 0)
  
predictions <- dataInput[,-1]
  
bonus <- -50*(predictions[topClub,]==1)
ssq <- function(x){(x-clubStandings)^2}
squares <- apply(predictions,2,ssq)
  
Impact <- c(clubsABC, "Bonus")
bonusSquare <- rbind(squares, bonus)
bonusSquares <- cbind(Impact, bonusSquare) %>% 
  as_data_frame() %>% 
  gather(key = "Player", -Impact, value = "Loss")
bonusSquares$Loss <- as.integer(bonusSquares$Loss)
  
score <- colSums(squares) + bonus
names <- colnames(score)
names1 <- str_replace_all(names, "_", " ")
worst <- apply(squares,2,max)
findWorst <- function(y){match(worst[y],squares[,y],0)}
worstClubNo <- sapply(1:ncol(predictions),findWorst)
worstClub <- clubsABC[worstClubNo]
  
output <- rbind(score, bonus, worst, worstClubNo)
output1 <- data.frame(names1,t(output))
row.names(output1) <- NULL 
output2 <- output1 %>% 
  mutate(worstClub=clubsABC[worstClubNo]) %>%
  select(-worstClubNo) 
colnames(output2) <- c("Names", "Scores", "Bonus", "WorstCost", "WorstClub")
  
report <- output2 %>% 
  arrange(Scores) %>% 
  select(Names, Scores, Bonus, WorstClub, WorstCost) %>% unite(WorstChoice, WorstClub, WorstCost, sep = ": ")
  
dtReport <- datatable(
  report, 
  rownames = FALSE, 
  options = list(
    dom = 't', 
    pageLength = 23, 
    order = list(
      list(1, 'asc'), 
      list(0, 'asc')),
    columnDefs = list(
      list(
        className = 'dt-left', 
        targets = c(0)
        ),
      list(
        className = 'dt-right', 
        targets = c(1, 2, 3)
        )
      )
    )
  )
  
frameWidget(dtReport, width = '100%', height = 800)
```

<p>&nbsp;</p>

Of course, there's still a long way to go, which I always find comforting. For more gory detail, check out the [PremPredict Leaderboard](https://robin.shinyapps.io/PremPredict/) to learn where we're all going wrong.
  
(And, for completeness, [here are your team-by-team predictions](https://docs.google.com/spreadsheets/d/18PTMQI_5Zxx7M1exASfGDDA148-6YoydRp5qkpegKKc/edit?usp=sharing) and the [latest team standings](http://www.theguardian.com/football/premierleague/table).)

<p>&nbsp;</p>

### Collective expectations

But what are we collectively expecting from the Premier League this season? Are we expecting this season to be as predictable as its predecessor? Or are we envisaging another Leicester-like season?

By the look of our picks, we seem to side with the bookies. We collectively predict Chelsea and the Manchester clubs to finish highest on average, with the recently-promoted teams struggling.

```{r, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE, fig.show='hold', fig.width = 6, fig.asp=0.618, out.width="100%", fig.align="center", error=TRUE}
dataInput1 <- as_data_frame(dataInput)
averageView <- round(rowMeans(dataInput1[, -1]), 2)
views <- cbind(dataInput1[,1], averageView)
  
dataInput2 <- dataInput1 %>% 
  gather(key = "Player", -Club, value = "Prediction") %>% 
  left_join(views, by = "Club")
  
ggplot(
  data = dataInput2,
  mapping = aes(
    y = reorder(Club, -averageView), 
    x = Prediction, 
    fill = averageView, 
    color = averageView
    )
  ) + 
  geom_ridgeline(
    stat = "binline", 
    bins = 20, scale = 0.95, 
    draw_baseline = FALSE
    ) + 
  scale_x_continuous(
    breaks = c(5, 10, 15, 20), 
    labels = c(5, 10, 15, 20)
    ) + 
  labs(
    y = "", x = "", 
    title = "\n Our collective predictions for this season \n"
    ) + 
  scale_fill_gradient(
    low = "green", high = "red", 
    guide=FALSE
    ) + 
  scale_color_gradient(
    low = "green", high = "red", 
    guide=FALSE
    ) +
  theme(
    title = element_text(size = 10), 
    axis.text.y = element_text(size = 6)
    )
```

<p>&nbsp;</p>

In short, most of us think that Huddersfield are doomed. And most of us are currently wrong, as they're third in the league!

***
