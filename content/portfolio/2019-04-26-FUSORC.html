---
title: "Frequently used snippets of R code"
author: "Robin Penfold"
date: "2019-04-26"
showonlyimage: false
draft: false
slug: "FUSORC"
image: "img/portfolio/R.jpg"
description: "Useful references"
weight: 2
output:
  blogdown::html_page:
    highlight: pygments
---

<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<p>Granted, <em>FUSORC</em> (Frequently Used Snippets Of R Code) isn’t as catchy as <em>FAQ</em>. However, I keep a list of FUSORC that I find valuable and – in the spirit of the R community – thought it best to share.</p>
<p>Here goes …</p>
<p></br></p>
<div id="begin-an-r-notebook" class="section level4">
<h4>Begin an R notebook</h4>
<p>I use the following code to start an R notebook.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="op">---</span>
title<span class="op">:</span><span class="st"> &quot;&quot;</span>
author<span class="op">:</span><span class="st"> &quot;Robin Penfold&quot;</span>
date<span class="op">:</span><span class="st"> &quot;&quot;</span>
output<span class="op">:</span><span class="st"> </span>
<span class="st">  </span>html_notebook<span class="op">:</span>
<span class="st">    </span>theme<span class="op">:</span><span class="st"> </span>sandstone
    highlight<span class="op">:</span><span class="st"> </span>pygments
    code_folding<span class="op">:</span><span class="st"> &quot;show&quot;</span>
    toc<span class="op">:</span><span class="st"> </span>true
    toc_float<span class="op">:</span><span class="st"> </span>true
    toc_depth<span class="op">:</span><span class="st"> </span><span class="dv">4</span>
<span class="op">---</span>

<span class="er">***</span>

<span class="co">### Introduction</span>

Add ...</code></pre>
<p>I also reduce the ouput by adding the following to the first code chunk (and setting <code>message</code> to <code>FALSE</code>):</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressMessages</span>(<span class="kw">library</span>(tidyverse))</code></pre>
<p></br></p>
</div>
<div id="count-outcomes" class="section level4">
<h4>Count outcomes</h4>
<p>Simple but frequently used.</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">count</span>(cyl, gear)</code></pre>
<pre><code>## # A tibble: 8 x 3
##     cyl  gear     n
##   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
## 1     4     3     1
## 2     4     4     8
## 3     4     5     2
## 4     6     3     2
## 5     6     4     4
## 6     6     5     1
## 7     8     3    12
## 8     8     5     2</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">count</span>(cyl, gear) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">count</span>(gear)</code></pre>
<pre><code>## # A tibble: 3 x 2
##    gear     n
##   &lt;dbl&gt; &lt;int&gt;
## 1     3     3
## 2     4     2
## 3     5     3</code></pre>
<p></br></p>
</div>
<div id="mutate-in-bulk" class="section level4">
<h4>Mutate in bulk</h4>
<pre class="sourceCode r"><code class="sourceCode r">iris <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate_at</span>(
    <span class="dt">.cols =</span> <span class="kw">vars</span>(<span class="op">-</span>Species),
    <span class="dt">.funs =</span> <span class="kw">funs</span>(. <span class="op">*</span><span class="st"> </span><span class="dv">100</span>)
    )</code></pre>
<p>As with the previous shortcut, I often need to mutate all but a few columns. Running the code directly above multiplies all columns in <code>iris</code> by 100 except for the <code>Species</code>. As with many of these snippets, the example shows the principle, which can be applied in many ways.</p>
<p></br></p>
</div>
<div id="reduce-ifelse-calls" class="section level4">
<h4>Reduce ifelse calls</h4>
<p>Taken from <a href="https://adv-r.hadley.nz">Advanced R</a> by Hadley Wickham, this infix function provides a default value in the case where the output of another function is <code>NULL</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rlang)

<span class="co"># `%||%` &lt;- function(a, b) if (!is.null(a)) a else b</span>

<span class="kw">function_that_might_return_NULL</span>() <span class="op">%||%</span><span class="st"> </span>default_value</code></pre>
<p></br></p>
</div>
<div id="scrape-web-data" class="section level4">
<h4>Scrape web data</h4>
<p>I tend to use the format <code>read_html(index_page) %&gt;% html_nodes(&quot;a&quot;) %&gt;% html_attr(&quot;href&quot;)</code>. (You also need to be outside a corporate firewall to do this.)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rvest)
<span class="kw">library</span>(xml2)

<span class="kw">read_html</span>(<span class="st">&quot;http://www.theguardian.com/football/premierleague/table&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_nodes</span>(<span class="st">&quot;.table--striped&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>.[[<span class="dv">1</span>]] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_table</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(Team<span class="op">:</span>Pts) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">head</span>()</code></pre>
<pre><code>##        Team GP  W D  L  F  A GD Pts
## 1  Man City 35 29 2  4 89 22 67  89
## 2 Liverpool 35 27 7  1 79 20 59  88
## 3     Spurs 35 23 1 11 65 35 30  70
## 4   Chelsea 35 20 7  8 59 38 21  67
## 5   Arsenal 35 20 6  9 69 46 23  66
## 6   Man Utd 35 19 7  9 63 50 13  64</code></pre>
<p></br></p>
</div>
<div id="select-some-columns" class="section level4">
<h4>Select some columns</h4>
<p>I often need to select all but a few columns that end in a certain way.</p>
<pre class="sourceCode r"><code class="sourceCode r">iris <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(
    <span class="kw">everything</span>(), 
    <span class="op">-</span><span class="kw">ends_with</span>(<span class="st">&quot;Width&quot;</span>)
    ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">head</span>()  </code></pre>
<pre><code>##   Sepal.Length Petal.Length Species
## 1          5.1          1.4  setosa
## 2          4.9          1.4  setosa
## 3          4.7          1.3  setosa
## 4          4.6          1.5  setosa
## 5          5.0          1.4  setosa
## 6          5.4          1.7  setosa</code></pre>
<p></br></p>
</div>
<div id="show-ggplot2-in-rmd" class="section level4">
<h4>Show ggplot2 in Rmd</h4>
<p>This code chunk metadata enables a ggplot2 object to appear nicely in Rmarkdown.</p>
<blockquote>
<p><code>{r, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE, fig.show='hold', fig.width = 6, fig.asp=0.618, out.width=&quot;70%&quot;, fig.align=&quot;center&quot;}</code></p>
</blockquote>
<p></br></p>
</div>
<div id="summarise-tidily" class="section level4">
<h4>Summarise tidily</h4>
<p>Do you ever need to summarise all columns in a dataframe using certain functions. I find this shortcut really helpful for doing so in a tidy way.</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">map_df</span>(
    <span class="dt">.x =</span> .,
    <span class="dt">.f =</span> <span class="op">~</span><span class="kw">tibble</span>(
      <span class="dt">sum =</span> <span class="kw">sum</span>(.x),
      <span class="dt">iqr =</span> <span class="kw">IQR</span>(.x),
      <span class="dt">min =</span> <span class="kw">min</span>(.x)
      ),
    <span class="dt">.id =</span> <span class="st">&quot;var_name&quot;</span>
    )</code></pre>
<pre><code>## # A tibble: 11 x 4
##    var_name   sum     iqr   min
##    &lt;chr&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
##  1 mpg       643.   7.38  10.4 
##  2 cyl       198    4      4   
##  3 disp     7383. 205.    71.1 
##  4 hp       4694   83.5   52   
##  5 drat      115.   0.840  2.76
##  6 wt        103.   1.03   1.51
##  7 qsec      571.   2.01  14.5 
##  8 vs         14    1      0   
##  9 am         13    1      0   
## 10 gear      118    1      3   
## 11 carb       90    2      1</code></pre>
<p></br></p>
</div>
<div id="translate-dplyr-to-sql" class="section level4">
<h4>Translate dplyr to SQL</h4>
<p>Even better, you can choose the dialect of SQL!</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(dbplyr)

df &lt;-<span class="st"> </span><span class="kw">tibble</span>(
  <span class="dt">y =</span> <span class="kw">c</span>(<span class="st">&#39;a&#39;</span>, <span class="st">&#39;b&#39;</span>, <span class="st">&#39;c&#39;</span>), 
  <span class="dt">z =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)
  )

x &lt;-<span class="st"> </span><span class="kw">tbl_lazy</span>(
  df, 
  <span class="dt">con =</span> <span class="kw">simulate_mssql</span>()
  )

x <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(y <span class="op">!=</span><span class="st"> &#39;a&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">x =</span> <span class="kw">sd</span>(z, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">show_query</span>()</code></pre>
<pre><code>## &lt;SQL&gt;
## SELECT STDEV(`z`) AS `x`
## FROM `df`
## WHERE (`y` != &#39;a&#39;)</code></pre>
<p></br></p>
</div>
<div id="miscellanea" class="section level4">
<h4>Miscellanea</h4>
<ul>
<li>Use <code>recode</code> and <code>recode_factor</code></li>
</ul>
<p></br></p>
<hr />
</div>
